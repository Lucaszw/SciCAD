#!/usr/bin/env electron
require('pkginfo')(module);
const Microdrop = require('../index.js');
const electron = require('electron');
const isDev = require('electron-is-dev');

// const PKG_NAME = module.exports.name;
const env = module.exports.environment;

if (!isDev) process.argv.unshift('');

const Ports = (argv) => {
 return {
   http_port:     argv.httpPort,
   mqtt_ws_port:  argv.mqttWsPort,
   mqtt_tcp_port: argv.mqttTcpPort
 };
}

const argv = require('yargs')
  .default('http-port', env.HTTP_PORT)
  .default('mqtt-ws-port', env.MQTT_WS_PORT)
  .default('mqtt-tcp-port', env.MQTT_TCP_PORT)
  .command('dump', 'dump state to file', async (yargs) => {
    const ports = Ports(yargs.argv);
    console.log(await Microdrop.dump(electron, ports));
    process.exit();
  })
  .command('start', 'start microdrop', async (yargs) => {
    Microdrop(electron, Ports(yargs.argv), argv.file);
  })
  .command('reset', 'Reset MicroDrop data', async (yargs) => {
    Microdrop.reset(electron, Ports(argv)).then((d) => {
      process.exit();
      // electron.app.exit();
    });
  })
  .argv;
